
name: Test Migration And Deploy Contentful

on:
  pull_request:
    branches: [ master ]
    paths:
      - "migrations/**"
      - ".github/workflows/pr.yml"
  push:
    branches: [ master ]
    paths:
      - "migrations/**"
      - ".github/workflows/pr.yml"

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [14.x]

    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Uses Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

  deploy_contentful:
    name: Deploy Contentful Sandbox
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v1
      
      - name: Uses Node.js 14
        uses: actions/setup-node@v1
        with:
          node-version: 14

      - name: Deploy Contentful
        id: migration
        uses: contentful/contentful-action@main
        env:
          delete_feature: false
          set_alias: true
          master_pattern: "prod-[DD].[MM].[YYYY]-[hh][mm][ss]"
          feature_pattern: "sandbox-[branch]"
          version_field: version
          version_content_type: versionTracking
          migrations_dir: test-migrations
          SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
          MANAGEMENT_API_KEY: ${{ secrets.CONTENTFUL_MANAGEMENT_API_KEY }}

      - name: Comment Contentful Info
        uses: peter-evans/commit-comment@v1
        with:
          body: |
            Contentful Environment Created and Migrated Successfully :sparkles:
            
            **Environment Name**: _${{ steps.migration.outputs.environment_name }}_

            Click [here][1] to go to new environment
            
            [1]: ${{steps.migration.outputs.environment_url}}